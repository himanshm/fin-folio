FROM node:22-alpine AS base

RUN corepack enable && corepack prepare pnpm@latest --activate

WORKDIR /usr/app

# Copy monorepo-level files
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./

# Copy each app's package.json so pnpm can resolve workspace deps
COPY apps/fin-folio-client/package.json apps/fin-folio-client/
COPY apps/fin-folio-server/package.json apps/fin-folio-server/

# Install all workspace deps (only once)
RUN pnpm install --frozen-lockfile

# ---------- CLIENT ----------
FROM base AS client
WORKDIR /usr/app/apps/fin-folio-client
COPY apps/fin-folio-client .
EXPOSE 5173
CMD ["pnpm", "run", "dev", "--", "--host"]

# ---------- SERVER ----------
FROM base AS server
WORKDIR /usr/app/apps/fin-folio-server
COPY apps/fin-folio-server .
EXPOSE 8081
CMD ["pnpm", "run", "dev"]